<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ê¸°ì‚¬ì˜ íƒ€ì´í‹€ê³¼ ë¶ˆì•ˆê°ì˜ ì—°ê´€ì„± ì¡°ì‚¬</title>
<meta name="theme-color" content="#1f4aff">
<style>
:root{
  --bg:#0b1020; --surface:#0f1530; --card:#121a3a;
  --text:#eef2ff; --muted:#9aa7cf; --border:#253166;
  --accent:#4f7fff; --accent-2:#8fb4ff; --ok:#33d37b; --fail:#ff6b6b;
  --radius:16px; --rsm:12px; --shadow:0 12px 30px rgba(10,20,60,.35);
}
*{box-sizing:border-box}
html,body{
  margin:0; padding:0; background:var(--bg); color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,'Apple SD Gothic Neo','Noto Sans KR','Malgun Gothic',sans-serif
}
a{color:var(--accent-2);text-decoration:none}
.container{max-width:980px;margin:28px auto;padding:0 18px}

/* í—¤ë” */
.header{display:flex;align-items:center;gap:14px;padding:18px 18px 0}
.logo{width:42px;height:42px;border-radius:12px;overflow:hidden;box-shadow:var(--shadow)}
.logo img{width:100%;height:100%;object-fit:cover}
.brand{font-size:22px;font-weight:800;letter-spacing:.2px}
.subtitle{color:var(--muted);margin:4px 0 0}

/* ì¹´ë“œ/ë³¸ë¬¸ */
.card{background:linear-gradient(180deg,var(--card),var(--surface));border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin:18px 0;box-shadow:var(--shadow)}
h1,h2{margin:0 0 10px} h2{font-size:18px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:10px}
label{display:block;margin:10px 0}
input[type=text],select,textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:var(--rsm);background:#0e1633;color:var(--text)}

/* ë²„íŠ¼ */
.btn{display:inline-block;padding:11px 16px;border-radius:12px;border:1px solid var(--accent);background:var(--accent);color:#fff;cursor:pointer;font-weight:700;letter-spacing:.2px;transition:.15s transform ease}
.btn:active{transform:translateY(1px)}
.btn.secondary{background:transparent;color:var(--accent)}
.btn.ghost{background:transparent;color:var(--text);border-color:var(--border)}
.btn.disabled{opacity:.55;pointer-events:none}
.actions{margin-top:14px;display:flex;gap:8px;flex-wrap:wrap}

/* ì§„í–‰ë°” */
.progress{height:10px;background:#0f1a3b;border-radius:8px;overflow:hidden;margin-bottom:12px;border:1px solid var(--border)}
.progbar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .3s}

/* ê¸°ì‚¬ */
.news-image{width:100%;max-height:280px;object-fit:cover;border-radius:12px;border:1px solid var(--border);margin:6px 0 10px}
.lede{color:var(--muted)}
.qa{margin-top:10px}
.ticks{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:4px;pointer-events:none}

/* ìƒíƒœ/ë°°ì§€ */
.badge{display:inline-block;padding:3px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#0e1633;color:var(--muted)}
.badge.ok{color:#c9ffe0;border-color:var(--ok);background:#0f2a1d}
.badge.fail{color:#ffe1df;border-color:var(--fail);background:#2a1010}

/* í…Œì´ë¸”/í‘¸í„° */
#summary table{width:100%;border-collapse:collapse}
#summary th,#summary td{border:1px solid var(--border);padding:8px;text-align:left}
footer{padding:24px;color:var(--muted);text-align:center}

/* ìœ í‹¸ */
.hidden{display:none !important}
#policyBtns .active{outline:2px solid var(--accent)}
.small{font-size:12px;color:var(--muted)}

/* ìŠ¬ë¼ì´ë” */
input[type="range"]{-webkit-appearance:none;appearance:none;width:100%;background:transparent;touch-action:pan-y}
input[type="range"]::-webkit-slider-runnable-track{height:8px;background:#243063;border-radius:6px}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;border-radius:50%;background:#1f4aff;border:2px solid #8fb4ff;margin-top:-6px}
input[type="range"]::-moz-range-track{height:8px;background:#243063;border-radius:6px}
input[type="range"]::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:#1f4aff;border:2px solid #8fb4ff}
.value-badge{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0e1633;color:#cfd8ff;font-size:12px}
/* ==== ìœ í˜• ì¹´ë“œ ==== */
.type-card{margin-top:14px;padding:16px;border:1px solid var(--border);
  border-radius:14px;background:#0e1633}
.type-badge{display:inline-block;margin-bottom:8px;padding:4px 10px;border-radius:999px;
  border:1px solid var(--accent);color:var(--accent-2);font-weight:700}
.type-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:10px}
.type-pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="header container">
    <div class="logo"><img src="./logo.png" alt="Logo"></div>
    <div>
      <div class="brand">AFL ìœ í˜• ê²€ì‚¬</div>
      <div class="subtitle">ê¸°ì‚¬ì˜ íƒ€ì´í‹€ì´ ë¶ˆì•ˆê°ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ê³¼ ê·¸ì— ë”°ë¥¸ ì •ì±… ì„ í˜¸ë„ ì¡°ì‚¬</div>
    </div>
  </div>

  <main class="container">
    <!-- ì¸íŠ¸ë¡œ -->
    <section id="screen-intro" class="card">
      <h1>ì°¸ì—¬ ì•ˆë‚´</h1>
      <p class="subtitle">
        ë™ì¼í•œ ì‚¬ê±´ì„ <strong>ì„œë¡œ ë‹¤ë¥¸ í‘œí˜„</strong>ìœ¼ë¡œ ë³´ë„í–ˆì„ ë•Œ,
        ê¸°ì‚¬ì˜ í‘œí˜„ì´ ë…ìì˜ <strong>ì‹¬ë¦¬</strong>ì™€ <strong>ì •ì±… ì˜ê²¬</strong>ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ì¡°ì‚¬í•˜ë ¤ê³  í•©ë‹ˆë‹¤.
      </p>
      <ul class="small">
        <li>ì¼ë¶€ ë¼ìš´ë“œì—ì„œëŠ” <strong>ê°ê´€ì ì¸ íƒ€ì´í‹€ì˜ ê¸°ì‚¬</strong>,<strong>ë¶ˆì•ˆì˜ í”„ë ˆì„ì´ ê°€ì¤‘ëœ ê¸°ì‚¬</strong>ê°€ ë¬´ì‘ìœ„ë¡œ ì œì‹œë©ë‹ˆë‹¤.</li>
        <li>ì‘ë‹µì€ ìµëª… ì²˜ë¦¬ë˜ë©° ì—°êµ¬ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.</li>
      </ul>
      <div class="grid">
        <label>ë‹‰ë„¤ì„(ì„ íƒ)
          <input type="text" id="nickname" placeholder="ìµëª… ê°€ëŠ¥">
        </label>
        <label>ê´€ì‹¬ ë¶„ì•¼
          <select id="track">
            <option value="media">ì •ì±…Â·ì–¸ë¡ </option>
            <option value="psych">ì‹¬ë¦¬Â·ì‚¬íšŒ</option>
            <option value="law">ë²•Â·ì¹˜ì•ˆ</option>
            <option value="econ">ê²½ì œÂ·ìƒí™œ</option>
          </select>
        </label>
      </div>
      <div class="actions">
        <button id="btnStart" class="btn">ì‹œì‘í•˜ê¸°</button>
        <button id="btnPing" class="btn ghost">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
        <span id="onlineState" class="badge">ì „ì†¡ ì¤€ë¹„</span>
      </div>
      <p class="small">â€» ğŸ’¡ Tip. ì´ê³³ì—ëŠ” ì´ 6ê°œì˜ ë¼ìš´ë“œê°€ ì¤€ë¹„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
    </section>

    <!-- ë‹¨ì¼ ë¼ìš´ë“œ -->
    <section id="screen-trial" class="card hidden">
      <div class="progress"><div id="progBar" class="progbar"></div></div>
      <h2 id="headline"></h2>
      <img id="image" class="news-image" alt="">
      <p id="lede" class="lede"></p>

      <div class="qa">
        <label>ì§€ê¸ˆ ëŠë¼ëŠ” ë¶ˆì•ˆê°ì˜ ì •ë„ (1=ì „í˜€ ì•„ë‹˜ ~ 5=ë§¤ìš° í¼)
          <input type="range" id="anxiety" min="1" max="5" step="1" value="3">
          <span id="anxietyVal" class="value-badge">3 / 5</span>
          <div class="ticks"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span></div>
        </label>
        <label>ë‹¤ìŒ ì •ì±…ì— ëŒ€í•œ ì˜ê²¬: <em id="policy"></em>
          <div class="actions" id="policyBtns">
            <button data-v="ì°¬ì„±" class="btn secondary">ì°¬ì„±</button>
            <button data-v="ë°˜ëŒ€" class="btn secondary">ë°˜ëŒ€</button>
            <button data-v="ëª¨ë¦„" class="btn ghost">ëª¨ë¥´ê² ìŒ</button>
          </div>
        </label>
      </div>
      <div class="actions">
        <button id="btnNext" class="btn disabled">ë‹¤ìŒ</button>
        <span id="sendState" class="badge">ì „ì†¡ ëŒ€ê¸°</span>
      </div>
      <p class="hint small">ìˆ«ìí‚¤ 1~5ë¡œë„ ì¡°ì ˆ ê°€ëŠ¥</p>
    </section>

    <!-- ì™„ë£Œ -->
    <section id="screen-finish" class="card hidden">
      <h2>ì™„ë£Œ!</h2>
      <p class="subtitle">ì°¸ì—¬í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ì•„ë˜ì—ì„œ ê²°ê³¼ ìš”ì•½ì„ í™•ì¸í•˜ê±°ë‚˜ CSVë¡œ ë‚´ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”.</p>
      <div id="summary"></div>
      <div class="actions">
        <button id="btnReplay" class="btn">ë‹¤ì‹œ í•˜ê¸°</button>
        <button id="btnExport" class="btn secondary">CSV ë‹¤ìš´ë¡œë“œ</button>
        <button id="btnClear" class="btn ghost">ë°ì´í„° ì´ˆê¸°í™”</button>
        <button id="btnResend" class="btn ghost">ë¯¸ì „ì†¡ ì¬ì „ì†¡</button>
      </div>
    </section>
  </main>

  <footer>Â© ë¹„ê³µì‹ìë°œì ì§‘ë‹¨ - 30307 , 30314</footer>

<script>
// ===== ì„¤ì • =====
const ENDPOINT = "https://script.google.com/macros/s/AKfycbyQ5sSESrUxTEa5fV6RHlLm5pGapr0oRhdkH_cVYeGjDyhER0qtBOjSFdK-CG-SVmc6Yw/exec";
const TOKEN = "";
const MAX_ROUNDS = 6; // ì´ë²ˆ í”Œë ˆì´ ë¼ìš´ë“œ ìˆ˜

// ===== ì´ë¯¸ì§€ =====
const IMAGES = {
  gangnam_dropout: "https://source.unsplash.com/1200x700/?classroom,study",
  nk_claim: "https://source.unsplash.com/1200x700/?geneva,conference",
  school_drugs: "https://source.unsplash.com/1200x700/?police,school",
  pattaya_drum: "https://source.unsplash.com/1200x700/?thailand,police",
  seocheon_murder: "https://source.unsplash.com/1200x700/?police,tape",
  busan_chem: "https://source.unsplash.com/1200x700/?hazmat,chemical",
  yellow_envelope: "https://source.unsplash.com/1200x700/?protest,workers"
};
// ì¶”ê°€ ì´ë¯¸ì§€ í‚¤
Object.assign(IMAGES, {
  cyber: "https://source.unsplash.com/1200x700/?cyber,security",
  ai_jobs: "https://source.unsplash.com/1200x700/?ai,work",
  inflation: "https://source.unsplash.com/1200x700/?inflation,prices",
  heatwave: "https://source.unsplash.com/1200x700/?heatwave,city",
  subway: "https://source.unsplash.com/1200x700/?subway,station"
});

// ===== ê¸°ì‚¬ ë°ì´í„°(ì´ 12ê°œ) =====
const SINGLE_ITEMS = [
  { id:"gangnam_dropout", topic:"êµìœ¡/í•™ì—…ì¤‘ë‹¨",
    neutral:{ title:"ê°•ë‚¨3êµ¬ ì¼ë°˜ê³  í•™ì—…ì¤‘ë‹¨ìœ¨, ì„œìš¸ì—ì„œ ê°€ì¥ ë†’ì•„", lede:"ìµœê·¼ í†µê³„ì— ë”°ë¥´ë©´ ê°•ë‚¨3êµ¬ ì¼ë°˜ê³ ì˜ í•™ì—…ì¤‘ë‹¨ìœ¨ì´ ì„œìš¸ í‰ê· ë³´ë‹¤ ë†’ì€ ê²ƒìœ¼ë¡œ ë‚˜íƒ€ë‚¬ë‹¤. ìí‡´ í›„ ê²€ì •ê³ ì‹œë‚˜ ìˆ˜ëŠ¥ ì¤€ë¹„ë¥¼ ì„ íƒí•˜ëŠ” ì‚¬ë¡€ê°€ ë§ì•˜ë‹¤.", img:IMAGES.gangnam_dropout, policy:"í•™ì—…ì¤‘ë‹¨ ì˜ˆë°©ì„ ìœ„í•´ ìí‡´ ì‹¬ì‚¬ ê¸°ì¤€ì„ ê°•í™”í•´ì•¼ í•œë‹¤." },
    fear:{ title:"ê°•ë‚¨3êµ¬ ì¼ë°˜ê³ , í•™ìƒë“¤ ì¤„ì¤„ì´ ìí‡´â€¦ì„œìš¸ ìµœê³  í•™ì—…ì¤‘ë‹¨ìœ¨", lede:"ëª…ë¬¸ í•™êµ°ìœ¼ë¡œ ì•Œë ¤ì§„ ê°•ë‚¨3êµ¬ì—ì„œ í•™ì—…ì„ ì¤‘ë‹¨í•˜ëŠ” í•™ìƒì´ ê¸‰ì¦í•´ ì„œìš¸ ìµœê³  ìˆ˜ì¤€ì— ë‹¬í–ˆë‹¤. â€˜ë¯¸ë˜ë¥¼ ë²„ë¦° ì„ íƒâ€™ì´ë¼ëŠ” ìš°ë ¤ê°€ ì»¤ì§€ê³  ìˆë‹¤.", img:IMAGES.gangnam_dropout, policy:"í•™ì—…ì¤‘ë‹¨ ì˜ˆë°©ì„ ìœ„í•´ ìí‡´ ì‹¬ì‚¬ ê¸°ì¤€ì„ ê°•í™”í•´ì•¼ í•œë‹¤." } },
  { id:"nk_claim", topic:"ì•ˆë³´/êµ­ì œ",
    neutral:{ title:"åŒ— ì¸ë¯¼íšŒì˜ ì˜ì¥, ìŠ¤ìœ„ìŠ¤ì„œ í•œë¯¸ í•µì „ìŸ ì¤€ë¹„ ì£¼ì¥", lede:"ë¶í•œ ìµœíƒœë³µ ìµœê³ ì¸ë¯¼íšŒì˜ ì˜ì¥ì´ ìŠ¤ìœ„ìŠ¤ ì œë„¤ë°” íšŒì˜ì—ì„œ í•œêµ­ê³¼ ë¯¸êµ­ì´ í•µì „ìŸì„ ì¤€ë¹„í•˜ê³  ìˆë‹¤ê³  ë°œì–¸í–ˆë‹¤.", img:IMAGES.nk_claim, policy:"ë¶í•œì˜ êµ°ì‚¬ ë„ë°œ ê°€ëŠ¥ì„±ì— ëŒ€ë¹„í•´ í•œë¯¸ êµ°ì‚¬í›ˆë ¨ì„ í™•ëŒ€í•´ì•¼ í•œë‹¤." },
    fear:{ title:"åŒ—, â€œéŸ“Â·ç¾ í•µì „ìŸ ì¤€ë¹„ ì¤‘â€â€¦êµ­ì œíšŒì˜ì„œ ê¸´ì¥ ê³ ì¡°", lede:"ë¶í•œ ê³ ìœ„ê¸‰ ì¸ì‚¬ê°€ êµ­ì œì‚¬íšŒ ì•ì—ì„œ í•œêµ­ê³¼ ë¯¸êµ­ì´ í•µì „ìŸì„ ì¤€ë¹„ ì¤‘ì´ë¼ê³  ì£¼ì¥í•´ í•œë°˜ë„ ìœ„ê¸°ë¡ ì´ ì¬ì í™”ë˜ê³  ìˆë‹¤.", img:IMAGES.nk_claim, policy:"ë¶í•œì˜ êµ°ì‚¬ ë„ë°œ ê°€ëŠ¥ì„±ì— ëŒ€ë¹„í•´ í•œë¯¸ êµ°ì‚¬í›ˆë ¨ì„ í™•ëŒ€í•´ì•¼ í•œë‹¤." } },
  { id:"school_drugs", topic:"ì¹˜ì•ˆ/ë§ˆì•½",
    neutral:{ title:"ê°•ë‚¨ ì´ˆë“±í•™êµ ì•ì„œ ì´ìƒ í–‰ë™ ë³´ì¸ ë‚¨ì„±, ë§ˆì•½ íˆ¬ì•½ í™•ì¸", lede:"ê²½ì°°ì´ ê°•ë‚¨ì˜ í•œ ì´ˆë“±í•™êµ ì•ì—ì„œ ìˆ˜ìƒí•œ í–‰ë™ì„ í•˜ë˜ ë‚¨ì„±ì„ ê²€ê±°í•œ ê²°ê³¼ ë§ˆì•½ íˆ¬ì•½ ì‚¬ì‹¤ì´ í™•ì¸ëë‹¤.", img:IMAGES.school_drugs, policy:"í•™êµ ì£¼ë³€ì— ëŒ€í•œ ë§ˆì•½ ì „ìˆ˜ê²€ì‚¬ë¥¼ ê°•í™”í•´ì•¼ í•œë‹¤." },
    fear:{ title:"ì´ˆë“±í•™êµ ì• ë§ˆì•½ë²” í™œë³´â€¦í•™ë¶€ëª¨ ë¶ˆì•ˆ í™•ì‚°", lede:"ê°•ë‚¨ í•œ ì´ˆë“±í•™êµ ì•ì—ì„œ ë§ˆì•½ì— ì·¨í•œ ë‚¨ì„±ì´ ë°°íšŒí•˜ë‹¤ê°€ ê²½ì°°ì— ë¶™ì¡í˜”ë‹¤. â€˜ì•„ì´ë“¤ ì•ˆì „ì´ ìœ„í˜‘ë°›ëŠ”ë‹¤â€™ëŠ” ìš°ë ¤ê°€ ì»¤ì§€ê³  ìˆë‹¤.", img:IMAGES.school_drugs, policy:"í•™êµ ì£¼ë³€ì— ëŒ€í•œ ë§ˆì•½ ì „ìˆ˜ê²€ì‚¬ë¥¼ ê°•í™”í•´ì•¼ í•œë‹¤." } },
  { id:"pattaya_drum", topic:"í•´ì™¸/ë²”ì£„",
    neutral:{ title:"íŒŒíƒ€ì•¼ ì‚´ì¸ì‚¬ê±´ ê³µë²”, í˜„ì§€ ê²½ì°° ì¶”ì  ëì— ìµœí›„", lede:"íƒœêµ­ íŒŒíƒ€ì•¼ì—ì„œ ë°œìƒí•œ ë“œëŸ¼í†µ ì‚´ì¸ì‚¬ê±´ì˜ ê³µë²”ì´ í˜„ì§€ ê²½ì°° ì¶”ì  ëì— ì‚¬ë§í•œ ê²ƒìœ¼ë¡œ ì „í•´ì¡Œë‹¤.", img:IMAGES.pattaya_drum, policy:"í•´ì™¸ ì—¬í–‰ ì‹œ ìêµ­ë¯¼ ë³´í˜¸ë¥¼ ìœ„í•´ í˜„ì§€ ê²½ì°°ê³¼ì˜ ê³µì¡°ë¥¼ í™•ëŒ€í•´ì•¼ í•œë‹¤." },
    fear:{ title:"â€œìˆ  ì·¨í•œ í•œêµ­ì¸ íƒœì›Œâ€¦â€ íŒŒíƒ€ì•¼ ë“œëŸ¼í†µ ì‚´ì¸ ê³µë²”, ë¹„ê·¹ì  ìµœí›„", lede:"íƒœêµ­ íŒŒíƒ€ì•¼ì—ì„œ í•œêµ­ì¸ í”¼í•´ìê°€ ë“œëŸ¼í†µì— ìœ ê¸°ëœ ì‚¬ê±´ì˜ ê³µë²”ì´ ë„ì£¼ ëì— ìˆ¨ì¡Œë‹¤. ì”í˜¹í•œ ë²”í–‰ ìˆ˜ë²•ì´ ë‹¤ì‹œ ë„ë§ˆì— ì˜¬ëë‹¤.", img:IMAGES.pattaya_drum, policy:"í•´ì™¸ ì—¬í–‰ ì‹œ ìêµ­ë¯¼ ë³´í˜¸ë¥¼ ìœ„í•´ í˜„ì§€ ê²½ì°°ê³¼ì˜ ê³µì¡°ë¥¼ í™•ëŒ€í•´ì•¼ í•œë‹¤." } },
  { id:"seocheon_murder", topic:"ë¬»ì§€ë§ˆ ë²”ì£„",
    neutral:{ title:"ì„œì²œì„œ ì§€ì ì¥ì• ì¸ í”¼ì˜ì, ë¬´ì‘ìœ„ ì‚´ì¸ í˜ì˜ë¡œ ì²´í¬", lede:"ì¶©ë‚¨ ì„œì²œì—ì„œ 30ëŒ€ ì§€ì ì¥ì• ì¸ì´ ê¸¸ê±°ë¦¬ë¥¼ ë°°íšŒí•˜ë‹¤ê°€ ë¬´ì‘ìœ„ë¡œ í–‰ì¸ì„ ê³µê²©í•´ ì‚´í•´í•œ í˜ì˜ë¡œ ê²½ì°°ì— ì²´í¬ëë‹¤.", img:IMAGES.seocheon_murder, policy:"í‰ì•… ë²”ì£„ ì˜ˆë°©ì„ ìœ„í•´ ê³ ìœ„í—˜êµ°ì˜ ì™¸ë¶€ í™œë™ì„ ì œí•œí•´ì•¼ í•œë‹¤." },
    fear:{ title:"â€œëˆ„êµ¬ë“  ë…¸ë ¸ë‹¤â€â€¦ì„œì²œ ë¬»ì§€ë§ˆ ì‚´ì¸, 1ì‹œê°„ ë°°íšŒ ë ë²”í–‰", lede:"ì¶©ë‚¨ ì„œì²œì—ì„œ 30ëŒ€ ì§€ì ì¥ì• ì¸ì´ 1ì‹œê°„ ë„˜ê²Œ ë²”í–‰ ëŒ€ìƒì„ ë¬¼ìƒ‰í•˜ë‹¤ê°€ í–‰ì¸ì„ ì‚´í•´í–ˆë‹¤. ì£¼ë¯¼ ë¶ˆì•ˆì´ ì»¤ì§€ê³  ìˆë‹¤.", img:IMAGES.seocheon_murder, policy:"í‰ì•… ë²”ì£„ ì˜ˆë°©ì„ ìœ„í•´ ê³ ìœ„í—˜êµ°ì˜ ì™¸ë¶€ í™œë™ì„ ì œí•œí•´ì•¼ í•œë‹¤." } },
  { id:"busan_chem", topic:"ì¬ë‚œ/ì•ˆì „",
    neutral:{ title:"ë¶€ì‚° ê°•ë³€ëŒ€ë¡œ ìœ í•´í™”í•™ë¬¼ì§ˆ ìœ ì¶œ, 2ëª… ë¶€ìƒ", lede:"ë¶€ì‚° ê°•ë³€ëŒ€ë¡œì—ì„œ ìœ í•´í™”í•™ë¬¼ì§ˆì´ ìœ ì¶œë¼ ë„ë¡œ ê´€ë¦¬ì› 2ëª…ì´ ë¶€ìƒì„ ì…ì—ˆë‹¤. ê´€ê³„ ë‹¹êµ­ì´ ìœ ì¶œ ê²½ìœ„ë¥¼ ì¡°ì‚¬ ì¤‘ì´ë‹¤.", img:IMAGES.busan_chem, policy:"í™”í•™ë¬¼ì§ˆ ìš´ë°˜ ì°¨ëŸ‰ì— ëŒ€í•œ ì•ˆì „ ì ê²€ì„ ì˜ë¬´í™”í•´ì•¼ í•œë‹¤." },
    fear:{ title:"ë¶€ì‚° ë„ì‹¬ ìœ í•´ë¬¼ì§ˆ ìœ ì¶œâ€¦ì‹œë¯¼ ì•ˆì „ â€˜ë¹„ìƒâ€™", lede:"ë¶€ì‚° ê°•ë³€ëŒ€ë¡œì—ì„œ ìœ í•´í™”í•™ë¬¼ì§ˆì´ ëŒ€ëŸ‰ ìœ ì¶œë¼ 2ëª…ì´ ë‹¤ì³¤ë‹¤. ì¶”ê°€ í”¼í•´ì— ëŒ€í•œ ìš°ë ¤ê°€ ì»¤ì§€ê³  ìˆë‹¤.", img:IMAGES.busan_chem, policy:"í™”í•™ë¬¼ì§ˆ ìš´ë°˜ ì°¨ëŸ‰ì— ëŒ€í•œ ì•ˆì „ ì ê²€ì„ ì˜ë¬´í™”í•´ì•¼ í•œë‹¤." } },
  { id:"yellow_envelope", topic:"ì •ì±…/ë…¸ë™",
    neutral:{ title:"â€˜ë…¸ë€ ë´‰íˆ¬ë²•â€™ êµ­íšŒ í†µê³¼â€¦í•˜ì²­Â·íŠ¹ìˆ˜ê³ ìš© ë…¸ì¡° í™œë™ í™•ëŒ€", lede:"êµ­íšŒê°€ í•˜ì²­Â·íŠ¹ìˆ˜ê³ ìš© ë…¸ë™ìê°€ ì›ì²­ì„ ìƒëŒ€ë¡œ ë…¸ì¡° í™œë™ì„ í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ë‚´ìš©ì„ ë‹´ì€ ë²•ì•ˆì„ ì˜ê²°í–ˆë‹¤.", img:IMAGES.yellow_envelope, policy:"í•˜ì²­Â·íŠ¹ìˆ˜ê³ ìš© ë…¸ë™ìì—ê²Œ ì›ì²­ ìƒëŒ€ ë…¸ì¡° í™œë™ì„ í—ˆìš©í•´ì•¼ í•œë‹¤." },
    fear:{ title:"ë…¸ë€ ë´‰íˆ¬ë²• í†µê³¼â€¦ê¸°ì—… ê²½ì˜ ë¶€ë‹´Â·ê²½ì œ ì•…ì˜í–¥ ìš°ë ¤", lede:"ë…¸ì¡° ê¶Œí•œ ê°•í™”ë¡œ ê¸°ì—… í™œë™ ìœ„ì¶•ì´ ìš°ë ¤ëœë‹¤ëŠ” ì§€ì ì´ ë‚˜ì˜¨ë‹¤.", img:IMAGES.yellow_envelope, policy:"í•˜ì²­Â·íŠ¹ìˆ˜ê³ ìš© ë…¸ë™ìì—ê²Œ ì›ì²­ ìƒëŒ€ ë…¸ì¡° í™œë™ì„ í—ˆìš©í•´ì•¼ í•œë‹¤." } },

  // ì¶”ê°€ 5ê°œ
  { id:"cyber_attack", topic:"ì¹˜ì•ˆ/ì‚¬ì´ë²„",
    neutral:{ title:"ê³µê³µê¸°ê´€ ì›¹ì‚¬ì´íŠ¸, ì¼ì‹œì  ì ‘ì† ì§€ì—°â€¦ë³´ì•ˆ ì ê²€ ì§„í–‰", lede:"ì¼ë¶€ ê³µê³µê¸°ê´€ ì‚¬ì´íŠ¸ì—ì„œ íŠ¸ë˜í”½ ê¸‰ì¦ìœ¼ë¡œ ì ‘ì† ì§€ì—°ì´ ë°œìƒí•´ ë³´ì•ˆ ì ê²€ì´ ì´ë¤„ì¡Œë‹¤.", img:IMAGES.cyber, policy:"ê³µê³µê¸°ê´€ì˜ ë³´ì•ˆ ì¸ë ¥ê³¼ ëª¨ì˜í›ˆë ¨ ì˜ˆì‚°ì„ í™•ëŒ€í•´ì•¼ í•œë‹¤." },
    fear:{ title:"ëŒ€ê·œëª¨ í•´í‚¹ ì‹œë„â€¦ê³µê³µê¸°ê´€ ë§ˆë¹„ ìš°ë ¤", lede:"ì—°ì‡„ì  í•´í‚¹ ì‹œë„ë¡œ ê³µê³µê¸°ê´€ ì‚¬ì´íŠ¸ê°€ ë§ˆë¹„ë  ìˆ˜ ìˆë‹¤ëŠ” ìš°ë ¤ê°€ ì œê¸°ëë‹¤.", img:IMAGES.cyber, policy:"ê³µê³µê¸°ê´€ì˜ ë³´ì•ˆ ì¸ë ¥ê³¼ ëª¨ì˜í›ˆë ¨ ì˜ˆì‚°ì„ í™•ëŒ€í•´ì•¼ í•œë‹¤." } },
  { id:"ai_jobs", topic:"ê²½ì œ/ì¼ìë¦¬",
    neutral:{ title:"ê¸°ì—…, ë°˜ë³µì—…ë¬´ì— AI ë„ì… í™•ëŒ€â€¦ì§ë¬´ ì¬ì„¤ê³„ ë…¼ì˜", lede:"ì—¬ëŸ¬ ê¸°ì—…ì´ ë°˜ë³µÂ·ë¬¸ì„œ ì‘ì—…ì— AIë¥¼ ë„ì…í•˜ë©´ì„œ ì§ë¬´ ì¬ì„¤ê³„ì™€ êµìœ¡ì´ ì§„í–‰ë˜ê³  ìˆë‹¤.", img:IMAGES.ai_jobs, policy:"ì •ë¶€ê°€ ì¬ì§ì ì „í™˜êµìœ¡ ë°”ìš°ì²˜ë¥¼ ì§€ì›í•´ì•¼ í•œë‹¤." },
    fear:{ title:"AI í™•ì‚°ì— ì¼ìë¦¬ ëŒ€ì²´ ê°€ì†â€¦ì²­ë…„ ê³ ìš© â€˜ê²½ê³ ë“±â€™", lede:"AIê°€ ë¹ ë¥´ê²Œ ë„ì…ë˜ë©° ì¼ë¶€ ì§ë¬´ì˜ ì¼ìë¦¬ ê°ì†Œ ê°€ëŠ¥ì„±ì´ ì œê¸°ëœë‹¤.", img:IMAGES.ai_jobs, policy:"ì •ë¶€ê°€ ì¬ì§ì ì „í™˜êµìœ¡ ë°”ìš°ì²˜ë¥¼ ì§€ì›í•´ì•¼ í•œë‹¤." } },
  { id:"inflation", topic:"ê²½ì œ/ë¬¼ê°€",
    neutral:{ title:"ìƒí™œë¬¼ê°€ ì†Œí­ ìƒìŠ¹â€¦ì •ë¶€, í• ì¸ ì§€ì› ì—°ì¥", lede:"ì‹ ì„ ì‹í’ˆ ì¤‘ì‹¬ìœ¼ë¡œ ìƒí™œë¬¼ê°€ê°€ ì†Œí­ ìƒìŠ¹í•´ ì •ë¶€ê°€ í• ì¸ ì§€ì›ì„ ì—°ì¥í•˜ê¸°ë¡œ í–ˆë‹¤.", img:IMAGES.inflation, policy:"ìƒí•„í’ˆ ê°€ê²© ëª¨ë‹ˆí„°ë§ê³¼ í• ì¸ ì •ì±…ì„ í™•ëŒ€í•´ì•¼ í•œë‹¤." },
    fear:{ title:"ì¥ë°”êµ¬ë‹ˆ ë¬¼ê°€ â€˜ë˜ ê¸‰ë“±â€™â€¦ê°€ê³„ ë¶€ë‹´ ì»¤ì§„ë‹¤", lede:"ìƒí™œí•„ìˆ˜í’ˆ ê°€ê²©ì´ ì‡ë”°ë¼ ì˜¤ë¥´ë©° ê°€ê³„ ë¶€ë‹´ì´ ì»¤ì§€ê³  ìˆë‹¤.", img:IMAGES.inflation, policy:"ìƒí•„í’ˆ ê°€ê²© ëª¨ë‹ˆí„°ë§ê³¼ í• ì¸ ì •ì±…ì„ í™•ëŒ€í•´ì•¼ í•œë‹¤." } },
  { id:"heatwave", topic:"ì¬ë‚œ/ê¸°í›„",
    neutral:{ title:"ë„ì‹¬ ì—´ì„¬ í˜„ìƒ í™•ëŒ€â€¦ê·¸ëŠ˜Â·ì¿¨ë£¨í”„ ì‚¬ì—… ì¶”ì§„", lede:"ì§€ìì²´ê°€ ê·¸ëŠ˜ë§‰, ì¿¨ë£¨í”„ ë“± í­ì—¼ ì™„í™” ì‚¬ì—…ì„ í™•ëŒ€í•œë‹¤.", img:IMAGES.heatwave, policy:"í­ì—¼ ê²½ë³´ ì‹œ ê³µê³µ ëƒ‰ë°©ì‹œì„¤ì„ ë¬´ë£Œ ê°œë°©í•´ì•¼ í•œë‹¤." },
    fear:{ title:"ê¸°ë¡ì  í­ì—¼ ë¹„ìƒâ€¦ì˜¨ì—´ì§ˆí™˜ ê¸‰ì¦ ìš°ë ¤", lede:"ì—°ì¼ ì´ì–´ì§€ëŠ” í­ì—¼ìœ¼ë¡œ ì·¨ì•½ê³„ì¸µì˜ ê±´ê°• í”¼í•´ê°€ ìš°ë ¤ëœë‹¤.", img:IMAGES.heatwave, policy:"í­ì—¼ ê²½ë³´ ì‹œ ê³µê³µ ëƒ‰ë°©ì‹œì„¤ì„ ë¬´ë£Œ ê°œë°©í•´ì•¼ í•œë‹¤." } },
  { id:"subway_incident", topic:"ëŒ€ì¤‘êµí†µ/ì•ˆì „",
    neutral:{ title:"ì§€í•˜ì²  ì†Œë€, ì‹ ì† ìˆ˜ìŠµâ€¦ìš´í–‰ ì •ìƒí™”", lede:"ì¶œê·¼ê¸¸ ì§€í•˜ì² ì—ì„œ ì†Œë€ì´ ìˆì—ˆì§€ë§Œ ì‹ ì†íˆ ìˆ˜ìŠµëë‹¤.", img:IMAGES.subway, policy:"ëŒ€ì¤‘êµí†µ ë³´ì•ˆìš”ì› ë°°ì¹˜ë¥¼ í™•ëŒ€í•´ì•¼ í•œë‹¤." },
    fear:{ title:"ì¶œê·¼ê¸¸ ì§€í•˜ì² ì„œ ìŠ¹ê° â€˜ì•„ì°”â€™â€¦ì•ˆì „ ë¶ˆì•ˆ ì»¤ì ¸", lede:"ì§€í•˜ì²  ì°¨ëŸ‰ ë‚´ ì†Œë€ìœ¼ë¡œ ìŠ¹ê°ë“¤ì´ ë¶ˆì•ˆì„ í˜¸ì†Œí–ˆë‹¤.", img:IMAGES.subway, policy:"ëŒ€ì¤‘êµí†µ ë³´ì•ˆìš”ì› ë°°ì¹˜ë¥¼ í™•ëŒ€í•´ì•¼ í•œë‹¤." } }
];

// ===== íŠ¸ë™ ë§¤í•‘(ìš°ì„  ë…¸ì¶œ) =====
const TOPIC_TRACKS = {
  'êµìœ¡/í•™ì—…ì¤‘ë‹¨':['media','psych'],
  'ì•ˆë³´/êµ­ì œ':['media','law'],
  'ì¹˜ì•ˆ/ë§ˆì•½':['media','psych','law'],
  'í•´ì™¸/ë²”ì£„':['psych','law'],
  'ë¬»ì§€ë§ˆ ë²”ì£„':['psych','law'],
  'ì¬ë‚œ/ì•ˆì „':['media','econ'],
  'ì •ì±…/ë…¸ë™':['media','law','econ'],
  'ì¹˜ì•ˆ/ì‚¬ì´ë²„':['media','law'],
  'ê²½ì œ/ì¼ìë¦¬':['econ','media'],
  'ê²½ì œ/ë¬¼ê°€':['econ'],
  'ì¬ë‚œ/ê¸°í›„':['media','econ'],
  'ëŒ€ì¤‘êµí†µ/ì•ˆì „':['media','law']
};
const matchesTrack = (topic, track)=>(TOPIC_TRACKS[topic]||[]).includes(track);

// ===== ìœ í‹¸ =====
const $ = (id)=>document.getElementById(id);
const shuffle = (arr)=>arr.sort(()=>Math.random()-0.5);
const download = (filename, text)=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'})); a.download=filename; a.click(); URL.revokeObjectURL(a.href); };
const toCSV = (rows)=>{ if(!rows.length) return ''; const cols=Object.keys(rows[0]); const head=cols.join(','); const body=rows.map(r=>cols.map(c=>`"${String(r[c]??'').replaceAll('"','""')}"`).join(',')).join('\n'); return head+'\n'+body; };

// ===== ìƒíƒœ =====
let POOL = SINGLE_ITEMS;          // ì´ë²ˆ í”Œë ˆì´ì— ì‚¬ìš©í•  6ê°œ
let sequence = [];                // ë¼ìš´ë“œ ìˆœì„œ(0..POOL.length-1)
let idx = 0;
let startTime = 0;
let currentPolicyChoice = null;

const LS_KEY = 'al_records_random_photo_v4';
const LS_UNSENT = 'al_unsent_random_photo_v4';
let saved = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
let unsent = JSON.parse(localStorage.getItem(LS_UNSENT)||'[]');

// ===== ì „ì†¡ =====
async function postRows(rows){
  const payload={token:TOKEN, rows};
  const res=await fetch(ENDPOINT,{method:'POST', body:JSON.stringify(payload)});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return res.text();
}
async function flushUnsent(){
  if(!unsent.length) return true;
  $('onlineState').textContent = `ë¯¸ì „ì†¡ ${unsent.length}ê±´ ì „ì†¡ ì¤‘â€¦`;
  try{ await postRows(unsent); unsent=[]; localStorage.setItem(LS_UNSENT, JSON.stringify(unsent)); $('onlineState').textContent='ì˜¨ë¼ì¸ ì „ì†¡ ì •ìƒ'; $('onlineState').className='badge ok'; return true; }
  catch(e){ $('onlineState').textContent='ì „ì†¡ ì‹¤íŒ¨(ë³´ê´€ ì¤‘)'; $('onlineState').className='badge fail'; return false; }
}

// ===== ìŠ¬ë¼ì´ë” ìŠ¤ëƒ… + ë°°ì§€ =====
function snapInt1to5(el){ let v=Math.round(Number(el.value||3)); v=Math.max(1,Math.min(5,v)); if(String(v)!==el.value) el.value=String(v); }
function bindSlider(id,badgeId){ const el=$(id), badge=$(badgeId); if(!el) return; const upd=()=>{ snapInt1to5(el); if(badge) badge.textContent=`${el.value} / 5`; }; el.addEventListener('input',upd); el.addEventListener('change',upd); upd(); }

// ===== ì´ˆê¸°í™” =====
window.addEventListener('DOMContentLoaded', ()=>{
  $('btnStart').addEventListener('click', start);
  $('btnPing').addEventListener('click', sendPing);
  $('btnNext').addEventListener('click', nextSingle);
  $('btnReplay').addEventListener('click', ()=>location.reload());
  $('btnExport').addEventListener('click', ()=>download('anxiety_lab_records.csv', toCSV(saved)));
  $('btnClear').addEventListener('click', ()=>{ if(confirm('ê¸°ê¸°ì— ì €ì¥ëœ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')){ saved=[]; unsent=[]; localStorage.removeItem(LS_KEY); localStorage.removeItem(LS_UNSENT); alert('ì‚­ì œ ì™„ë£Œ'); } });
  $('btnResend').addEventListener('click', flushUnsent);

  // í‚¤ë³´ë“œ 1~5 â†’ ìŠ¬ë¼ì´ë” + ë°°ì§€ ë™ê¸°í™”
  window.addEventListener('keydown', (e)=>{
    if(!['1','2','3','4','5'].includes(e.key)) return;
    const s = $('anxiety'), b = $('anxietyVal');
    s.value = e.key; snapInt1to5(s); if(b) b.textContent = `${s.value} / 5`;
  });

  document.querySelectorAll('#policyBtns button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      currentPolicyChoice=btn.dataset.v;
      document.querySelectorAll('#policyBtns button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active'); $('btnNext').classList.remove('disabled');
    });
  });

  bindSlider('anxiety','anxietyVal');

  if(unsent.length){ $('onlineState').textContent=`ë¯¸ì „ì†¡ ${unsent.length}ê±´ ë³´ê´€ ì¤‘`; $('onlineState').className='badge fail'; }
});

// ===== ì—°ê²° í…ŒìŠ¤íŠ¸ =====
async function sendPing(){
  const row={timestamp:new Date().toISOString(), nickname:'PING', track:'media', trial_index:0, item_id:'ping', topic:'ping', variant:'ping', title:'PING TEST', policy_prompt:'PING', anxiety_1to5:0, policy_attitude:'PING', rt_ms:0};
  $('onlineState').textContent='í…ŒìŠ¤íŠ¸ ì „ì†¡ ì¤‘â€¦'; $('onlineState').className='badge';
  try{ await postRows([row]); $('onlineState').textContent='ì—°ê²° ì •ìƒ(PING ê¸°ë¡ë¨)'; $('onlineState').className='badge ok'; }
  catch(e){ $('onlineState').textContent='ì—°ê²° ì‹¤íŒ¨(ì„¤ì • í™•ì¸ í•„ìš”)'; $('onlineState').className='badge fail'; }
}

// ===== íë¦„ =====
function start(){
  const chosen = $('track').value; // media/psych/law/econ

  // 1) íŠ¸ë™ ë§ëŠ” ê¸°ì‚¬ ìš°ì„ 
  const primary = SINGLE_ITEMS.filter(it => matchesTrack(it.topic, chosen));
  const rest = SINGLE_ITEMS.filter(it => !primary.includes(it));

  // 2) ë¶€ì¡±ë¶„ ë³´ì¶© â†’ 6ê°œ ì„ ì •
  POOL = [...primary, ...shuffle(rest)];
  POOL = POOL.slice(0, MAX_ROUNDS);

  // 3) ë¼ìš´ë“œ ì‹œí€€ìŠ¤(0..POOL.length-1) ì„ê¸°
  sequence = Array.from({length: POOL.length}, (_,i)=>i);
  sequence = shuffle(sequence);

  idx = 0;
  $('screen-intro').classList.add('hidden');
  renderCurrent();
  flushUnsent();
}

function renderCurrent(){
  const cur = sequence[idx];
  const progress = Math.floor((idx / POOL.length) * 100);

  $('screen-trial').classList.remove('hidden');

  const item = POOL[cur];
  const variant = Math.random()<0.5 ? 'neutral' : 'fear';
  const v = item[variant];

  $('progBar').style.width = progress+'%';
  $('headline').textContent = v.title;
  $('lede').textContent = v.lede;
  $('image').src = v.img;
  $('policy').textContent = v.policy;

  $('anxiety').value = 3; snapInt1to5($('anxiety')); $('anxietyVal').textContent='3 / 5';
  currentPolicyChoice = null;
  document.querySelectorAll('#policyBtns button').forEach(b=>b.classList.remove('active'));
  $('btnNext').classList.add('disabled');
  $('sendState').textContent='ì „ì†¡ ëŒ€ê¸°'; $('sendState').className='badge';

  // context
  const trial = $('screen-trial');
  trial.dataset.item_id = item.id;
  trial.dataset.topic   = item.topic;
  trial.dataset.variant = variant;
  trial.dataset.title   = v.title;
  trial.dataset.policy  = v.policy;

  startTime = performance.now();
}

async function nextSingle(){
  if($('btnNext').classList.contains('disabled')) return;
  const ms = Math.round(performance.now()-startTime);
  const row = {
    timestamp: new Date().toISOString(),
    nickname: $('nickname').value.trim(),
    track: $('track').value,
    trial_index: idx+1,
    item_id: $('screen-trial').dataset.item_id,
    topic: $('screen-trial').dataset.topic,
    variant: $('screen-trial').dataset.variant,
    title: $('screen-trial').dataset.title,
    policy_prompt: $('screen-trial').dataset.policy,
    anxiety_1to5: Number($('anxiety').value),
    policy_attitude: currentPolicyChoice,
    rt_ms: ms
  };
  saved.push(row); localStorage.setItem(LS_KEY, JSON.stringify(saved));
  $('sendState').textContent='ì „ì†¡ ì¤‘â€¦';
  try{ await postRows([row]); $('sendState').textContent='ì „ì†¡ ì„±ê³µ'; $('sendState').className='badge ok'; }
  catch(e){ unsent.push(row); localStorage.setItem(LS_UNSENT, JSON.stringify(unsent)); $('sendState').textContent='ì „ì†¡ ì‹¤íŒ¨(ë³´ê´€)'; $('sendState').className='badge fail'; }

  idx++;
  if(idx < POOL.length) renderCurrent();
  else finish();
}
/* ==== 6ìœ í˜• ì •ì˜ ==== */
const TYPE_MAP = {
  "AFI": { name:"ê°ì •ì  ê°œí˜ê°€", badges:["ì„¸ìƒ ì¼ì— ë§ˆìŒì´ ë¨¼ì € ê°„ë‹¤","ê¸°ì‚¬ë¥¼ ì½ê³  ê·¸ëƒ¥ ë„˜ê¸°ì§ˆ ëª»í•¨","ë³€í™”ë¥¼ ë§Œë“¤ì–´ì•¼ ì§ì„±ì´ í’€ë¦¼"] },
  "CFI": { name:"ì°¨ë¶„í•œ ê°œí˜ê°€", badges:["ì†ì€ ëœ¨ê²ì§€ë§Œ ê²‰ì€ ì°¨ë¶„","ì •ë³´ì˜ ë‰˜ì•™ìŠ¤ë¥¼ ì˜ ì½ìŒ","ì •ì±… í† ë¡  ì¢‹ì•„í•¨"] },
  "AFN": { name:"ê°ì •ì  ììœ ì£¼ì˜ì", badges:["ë‚´ ë§ˆìŒì€ ë¡¤ëŸ¬ì½”ìŠ¤í„°","í‘œí˜„ë³´ë‹¨ ì‚¬ì‹¤ì„ ë³¸ë‹¤","ê°„ì„­ë³´ë‹¤ ììœ ë¥¼ ì„ í˜¸"] },
  "CFN": { name:"ë…ë¦½í˜• ê´€ì°°ì", badges:["ë§ˆìŒì˜ íŒŒë„ëŠ” ì”ì”","ë‚¨ë“¤ í¥ë¶„í•´ë„ ë‚œ ë¶„ì„ ì¤‘","ê°„ì„­ì€ ì ì„ìˆ˜ë¡ ì¢‹ë‹¤"] },
  "AFM": { name:"ê°ì •ì  ì¤‘ë„íŒŒ", badges:["ìƒí™© ë”°ë¼ ì…ì¥ ë°”ë€œ","ë§ˆìŒì˜ ê¸°ë³µì´ ìˆìŒ","ê· í˜•ì„ ë§ì¶”ë ¤ ë…¸ë ¥"] },
  "CFM": { name:"ê· í˜• ì¡íŒ ì¤‘ë„íŒŒ", badges:["ì”ì”í•œ í˜¸ìˆ˜ ê°™ì€ ë©˜íƒˆ","ëª¨ë“  ë©´ì„ ë‘ë£¨ ì‚´í•Œ","í¸í–¥ ì—†ì´ íŒë‹¨í•˜ë ¤ í•¨"] },
};

function classifyType(sessionRows){
  const mean = (arr)=>arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:0;
  const anx = sessionRows.map(r=>Number(r.anxiety_1to5)||0);
  const fear = sessionRows.filter(r=>r.variant==='fear').map(r=>Number(r.anxiety_1to5)||0);
  const neu  = sessionRows.filter(r=>r.variant==='neutral').map(r=>Number(r.anxiety_1to5)||0);
  const att  = sessionRows.map(r=>r.policy_attitude||"");

  const anxMean = mean(anx);
  const fearMean = mean(fear);
  const neuMean  = mean(neu);
  const frameDelta = Math.abs(fearMean - neuMean);

  const yes = att.filter(v=>v==='ì°¬ì„±').length;
  const no  = att.filter(v=>v==='ë°˜ëŒ€').length;
  const unk = att.filter(v=>v==='ëª¨ë¦„' || v==='ëª¨ë¥´ê² ìŒ').length;
  const total = Math.max(1, yes+no+unk);
  const yesRate = yes/total, noRate = no/total;

  const AorC = (anxMean >= 3.4) ? 'A' : 'C';
  const ForN = (frameDelta >= 0.8) ? 'F' : 'N';
  const diff = yesRate - noRate;
  const policy =
    (diff >= 0.20) ? 'I' :
    (diff <= -0.20) ? 'L' : 'M';

  const code = AorC + ForN + policy;
  const normalized = TYPE_MAP[code] ? code
                   : TYPE_MAP[AorC + ForN + 'M'] ? (AorC + ForN + 'M')
                   : TYPE_MAP[AorC + ForN + 'I'] ? (AorC + ForN + 'I')
                   : 'CFN';

  return {
    code: normalized,
    name: TYPE_MAP[normalized].name,
    badges: TYPE_MAP[normalized].badges,
    metrics: { anxMean, fearMean, neuMean, frameDelta, yesRate, noRate, unkRate: unk/total }
  };
}

function renderTypeCard(result){
  const m = result.metrics;
  const pct = (x)=>Math.round(x*100);
  const pills = result.badges.map(b=>`<span class="type-pill">â€¢ ${b}</span>`).join(' ');

  return `
    <div class="type-card">
      <div class="type-badge">ë‹¹ì‹ ì˜ ìœ í˜•</div>
      <h3 style="margin:6px 0 4px">${result.code} â€” ${result.name}</h3>
      <div class="type-grid" style="margin-top:8px">
        ${pills}
      </div>
      <div class="small" style="margin-top:10px;opacity:.9">
        í‰ê·  ë¶ˆì•ˆ ${m.anxMean.toFixed(2)} / 5 ãƒ» í”„ë ˆì´ë° ë¯¼ê°ë„ Î”${isNaN(m.frameDelta)?'-':m.frameDelta.toFixed(2)}
        ãƒ» ì •ì±… ì„±í–¥: ì°¬ì„± ${pct(m.yesRate)}% / ë°˜ëŒ€ ${pct(m.noRate)}% / ëª¨ë¦„ ${pct(m.unkRate)}%
      </div>
    </div>
  `;
}
function finish(){
  $('screen-trial').classList.add('hidden');
  $('screen-finish').classList.remove('hidden');

  const total = POOL.length; 
  const session = saved.slice(-total);

  const mean = (arr)=> (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2);
  const fear = session.filter(r=>r.variant==='fear').map(r=>r.anxiety_1to5);
  const neu  = session.filter(r=>r.variant==='neutral').map(r=>r.anxiety_1to5);
  const overall = mean(session.map(r=>r.anxiety_1to5));
  const fearAvg = fear.length?mean(fear):'-';
  const neuAvg  = neu.length?mean(neu):'-';

  const tableHTML = `
    <table>
      <tr><th>í‰ê·  ë¶ˆì•ˆ(ì „ì²´)</th><td>${overall}</td></tr>
      <tr><th>ê³µí¬ í”„ë ˆì„ í‰ê· </th><td>${fearAvg}</td></tr>
      <tr><th>ì¤‘ë¦½ í”„ë ˆì„ í‰ê· </th><td>${neuAvg}</td></tr>
      <tr><th>í‘œë³¸ í¬ê¸°</th><td>${session.length}</td></tr>
    </table>
    <p class="hint small">CSVë¡œ ë‚´ë³´ë‚´ë©´ ë¼ìš´ë“œë³„ ìƒì„¸ ë°ì´í„°ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.</p>
  `;

  const typeResult = classifyType(session);
  const card = renderTypeCard(typeResult);

  $('summary').innerHTML = card + tableHTML;
}
</script>
</body>
</html>
