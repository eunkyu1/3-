<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>최종 테스트 버전 — 기사 타이틀 × 불안 × 정책</title>
<meta name="theme-color" content="#1f4aff">
<style>
:root{
  --bg:#0b1020; --surface:#0f1530; --card:#121a3a;
  --text:#eef2ff; --muted:#9aa7cf; --border:#253166;
  --accent:#4f7fff; --accent-2:#8fb4ff; --ok:#33d37b; --fail:#ff6b6b;
  --radius:16px; --rsm:12px; --shadow:0 12px 30px rgba(10,20,60,.35);
}
*{box-sizing:border-box}
html,body{
  margin:0; padding:0; background:var(--bg); color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,'Apple SD Gothic Neo','Noto Sans KR','Malgun Gothic',sans-serif
}
a{color:var(--accent-2);text-decoration:none}
.container{max-width:980px;margin:28px auto;padding:0 18px}

/* 헤더 */
.header{display:flex;align-items:center;gap:14px;padding:18px 18px 0}
.logo{width:42px;height:42px;border-radius:12px;overflow:hidden;box-shadow:var(--shadow)}
.logo img{width:100%;height:100%;object-fit:cover}
.brand{font-size:22px;font-weight:800;letter-spacing:.2px}
.subtitle{color:var(--muted);margin:4px 0 0}

/* 카드/본문 */
.card{background:linear-gradient(180deg,var(--card),var(--surface));border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin:18px 0;box-shadow:var(--shadow)}
h1,h2{margin:0 0 10px} h2{font-size:18px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:10px}
label{display:block;margin:10px 0}
input[type=text],select,textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:var(--rsm);background:#0e1633;color:var(--text)}

/* 버튼 */
.btn{display:inline-block;padding:11px 16px;border-radius:12px;border:1px solid var(--accent);background:var(--accent);color:#fff;cursor:pointer;font-weight:700;letter-spacing:.2px;transition:.15s transform ease}
.btn:active{transform:translateY(1px)}
.btn.secondary{background:transparent;color:var(--accent)}
.btn.ghost{background:transparent;color:var(--text);border-color:var(--border)}
.btn.disabled{opacity:.55;pointer-events:none}
.actions{margin-top:14px;display:flex;gap:8px;flex-wrap:wrap}

/* 진행바 */
.progress{height:10px;background:#0f1a3b;border-radius:8px;overflow:hidden;margin-bottom:12px;border:1px solid var(--border)}
.progbar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .3s}

/* 기사 */
.news-image{width:100%;max-height:280px;object-fit:cover;border-radius:12px;border:1px solid var(--border);margin:6px 0 10px}
.lede{color:var(--muted)}
.qa{margin-top:10px}
.ticks{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:4px;pointer-events:none}

/* 상태/배지 */
.badge{display:inline-block;padding:3px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#0e1633;color:var(--muted)}
.badge.ok{color:#c9ffe0;border-color:var(--ok);background:#0f2a1d}
.badge.fail{color:#ffe1df;border-color:var(--fail);background:#2a1010}

/* 테이블/푸터 */
#summary table{width:100%;border-collapse:collapse}
#summary th,#summary td{border:1px solid var(--border);padding:8px;text-align:left}
footer{padding:24px;color:var(--muted);text-align:center}

/* 유틸 */
.hidden{display:none !important}
#policyBtns .active{outline:2px solid var(--accent)}
.small{font-size:12px;color:var(--muted)}

/* 슬라이더 */
input[type="range"]{-webkit-appearance:none;appearance:none;width:100%;background:transparent;touch-action:pan-y}
input[type="range"]::-webkit-slider-runnable-track{height:8px;background:#243063;border-radius:6px}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;border-radius:50%;background:#1f4aff;border:2px solid #8fb4ff;margin-top:-6px}
input[type="range"]::-moz-range-track{height:8px;background:#243063;border-radius:6px}
input[type="range"]::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:#1f4aff;border:2px solid #8fb4ff}
.value-badge{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0e1633;color:#cfd8ff;font-size:12px}
</style>
</head>
<body>
  <div class="header container">
    <div class="logo"><img src="./logo.png" alt="Logo"></div>
    <div>
      <div class="brand">최종 테스트 버전</div>
      <div class="subtitle">기사의 타이틀이 불안감에 미치는 영향과 그에 따른 정책 선호도 조사</div>
    </div>
  </div>

  <main class="container">
    <!-- 인트로 -->
    <section id="screen-intro" class="card">
      <h1>참여 안내</h1>
      <p class="subtitle">
        동일한 사건을 <strong>서로 다른 표현</strong>으로 보도했을 때,
        기사 표현이 독자의 <strong>불안감</strong>과 <strong>정책 의견</strong>에 미치는 영향을 측정합니다.
      </p>
      <ul class="small">
        <li>일부 라운드에서는 <strong>중립 기사</strong>, 일부 라운드에서는 <strong>불안 프레임 기사</strong>가 무작위로 제시됩니다.</li>
        <li>응답은 익명 처리되며 연구·교육 목적으로만 사용됩니다.</li>
      </ul>
      <div class="grid">
        <label>닉네임(선택)
          <input type="text" id="nickname" placeholder="익명 가능">
        </label>
        <label>관심 트랙
          <select id="track">
            <option value="media">정책·언론</option>
            <option value="psych">심리·사회</option>
            <option value="law">법·치안</option>
            <option value="econ">경제·생활</option>
          </select>
        </label>
      </div>
      <div class="actions">
        <button id="btnStart" class="btn">시작하기</button>
        <button id="btnPing" class="btn ghost">연결 테스트</button>
        <span id="onlineState" class="badge">전송 준비</span>
      </div>
      <p class="small">※ “연결 테스트”를 누르면 스프레드시트에 테스트 행이 1줄 기록됩니다.</p>
    </section>

    <!-- 단일 라운드 -->
    <section id="screen-trial" class="card hidden">
      <div class="progress"><div id="progBar" class="progbar"></div></div>
      <h2 id="headline"></h2>
      <img id="image" class="news-image" alt="">
      <p id="lede" class="lede"></p>

      <div class="qa">
        <label>지금 느끼는 불안 정도 (1=전혀 아님 ~ 5=매우 큼)
          <input type="range" id="anxiety" min="1" max="5" step="1" value="3">
          <span id="anxietyVal" class="value-badge">3 / 5</span>
          <div class="ticks"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span></div>
        </label>
        <label>다음 정책에 대한 태도: <em id="policy"></em>
          <div class="actions" id="policyBtns">
            <button data-v="찬성" class="btn secondary">찬성</button>
            <button data-v="반대" class="btn secondary">반대</button>
            <button data-v="모름" class="btn ghost">모름</button>
          </div>
        </label>
      </div>
      <div class="actions">
        <button id="btnNext" class="btn disabled">다음</button>
        <span id="sendState" class="badge">전송 대기</span>
      </div>
      <p class="hint small">숫자키 1~5로도 조절 가능</p>
    </section>

    <!-- 완료 -->
    <section id="screen-finish" class="card hidden">
      <h2>완료!</h2>
      <p class="subtitle">참여 고마워요. 아래 요약을 확인하거나 CSV로 내보낼 수 있어요.</p>
      <div id="summary"></div>
      <div class="actions">
        <button id="btnReplay" class="btn">다시 하기</button>
        <button id="btnExport" class="btn secondary">CSV 다운로드</button>
        <button id="btnClear" class="btn ghost">데이터 초기화</button>
        <button id="btnResend" class="btn ghost">미전송 재전송</button>
      </div>
    </section>
  </main>

  <footer>© 비공식자발적집단 - 30307 , 30314</footer>

<script>
// ===== 설정 =====
const ENDPOINT = "https://script.google.com/macros/s/AKfycbyQ5sSESrUxTEa5fV6RHlLm5pGapr0oRhdkH_cVYeGjDyhER0qtBOjSFdK-CG-SVmc6Yw/exec";
const TOKEN = "";
const MAX_ROUNDS = 6; // 이번 플레이 라운드 수

// ===== 이미지 =====
const IMAGES = {
  gangnam_dropout: "https://source.unsplash.com/1200x700/?classroom,study",
  nk_claim: "https://source.unsplash.com/1200x700/?geneva,conference",
  school_drugs: "https://source.unsplash.com/1200x700/?police,school",
  pattaya_drum: "https://source.unsplash.com/1200x700/?thailand,police",
  seocheon_murder: "https://source.unsplash.com/1200x700/?police,tape",
  busan_chem: "https://source.unsplash.com/1200x700/?hazmat,chemical",
  yellow_envelope: "https://source.unsplash.com/1200x700/?protest,workers"
};
// 추가 이미지 키
Object.assign(IMAGES, {
  cyber: "https://source.unsplash.com/1200x700/?cyber,security",
  ai_jobs: "https://source.unsplash.com/1200x700/?ai,work",
  inflation: "https://source.unsplash.com/1200x700/?inflation,prices",
  heatwave: "https://source.unsplash.com/1200x700/?heatwave,city",
  subway: "https://source.unsplash.com/1200x700/?subway,station"
});

// ===== 기사 데이터(총 12개) =====
const SINGLE_ITEMS = [
  { id:"gangnam_dropout", topic:"교육/학업중단",
    neutral:{ title:"강남3구 일반고 학업중단율, 서울에서 가장 높아", lede:"최근 통계에 따르면 강남3구 일반고의 학업중단율이 서울 평균보다 높은 것으로 나타났다. 자퇴 후 검정고시나 수능 준비를 선택하는 사례가 많았다.", img:IMAGES.gangnam_dropout, policy:"학업중단 예방을 위해 자퇴 심사 기준을 강화해야 한다." },
    fear:{ title:"강남3구 일반고, 학생들 줄줄이 자퇴…서울 최고 학업중단율", lede:"명문 학군으로 알려진 강남3구에서 학업을 중단하는 학생이 급증해 서울 최고 수준에 달했다. ‘미래를 버린 선택’이라는 우려가 커지고 있다.", img:IMAGES.gangnam_dropout, policy:"학업중단 예방을 위해 자퇴 심사 기준을 강화해야 한다." } },
  { id:"nk_claim", topic:"안보/국제",
    neutral:{ title:"北 인민회의 의장, 스위스서 한미 핵전쟁 준비 주장", lede:"북한 최태복 최고인민회의 의장이 스위스 제네바 회의에서 한국과 미국이 핵전쟁을 준비하고 있다고 발언했다.", img:IMAGES.nk_claim, policy:"북한의 군사 도발 가능성에 대비해 한미 군사훈련을 확대해야 한다." },
    fear:{ title:"北, “韓·美 핵전쟁 준비 중”…국제회의서 긴장 고조", lede:"북한 고위급 인사가 국제사회 앞에서 한국과 미국이 핵전쟁을 준비 중이라고 주장해 한반도 위기론이 재점화되고 있다.", img:IMAGES.nk_claim, policy:"북한의 군사 도발 가능성에 대비해 한미 군사훈련을 확대해야 한다." } },
  { id:"school_drugs", topic:"치안/마약",
    neutral:{ title:"강남 초등학교 앞서 이상 행동 보인 남성, 마약 투약 확인", lede:"경찰이 강남의 한 초등학교 앞에서 수상한 행동을 하던 남성을 검거한 결과 마약 투약 사실이 확인됐다.", img:IMAGES.school_drugs, policy:"학교 주변에 대한 마약 전수검사를 강화해야 한다." },
    fear:{ title:"초등학교 앞 마약범 활보…학부모 불안 확산", lede:"강남 한 초등학교 앞에서 마약에 취한 남성이 배회하다가 경찰에 붙잡혔다. ‘아이들 안전이 위협받는다’는 우려가 커지고 있다.", img:IMAGES.school_drugs, policy:"학교 주변에 대한 마약 전수검사를 강화해야 한다." } },
  { id:"pattaya_drum", topic:"해외/범죄",
    neutral:{ title:"파타야 살인사건 공범, 현지 경찰 추적 끝에 최후", lede:"태국 파타야에서 발생한 드럼통 살인사건의 공범이 현지 경찰 추적 끝에 사망한 것으로 전해졌다.", img:IMAGES.pattaya_drum, policy:"해외 여행 시 자국민 보호를 위해 현지 경찰과의 공조를 확대해야 한다." },
    fear:{ title:"“술 취한 한국인 태워…” 파타야 드럼통 살인 공범, 비극적 최후", lede:"태국 파타야에서 한국인 피해자가 드럼통에 유기된 사건의 공범이 도주 끝에 숨졌다. 잔혹한 범행 수법이 다시 도마에 올랐다.", img:IMAGES.pattaya_drum, policy:"해외 여행 시 자국민 보호를 위해 현지 경찰과의 공조를 확대해야 한다." } },
  { id:"seocheon_murder", topic:"묻지마 범죄",
    neutral:{ title:"서천서 지적장애인 피의자, 무작위 살인 혐의로 체포", lede:"충남 서천에서 30대 지적장애인이 길거리를 배회하다가 무작위로 행인을 공격해 살해한 혐의로 경찰에 체포됐다.", img:IMAGES.seocheon_murder, policy:"흉악 범죄 예방을 위해 고위험군의 외부 활동을 제한해야 한다." },
    fear:{ title:"“누구든 노렸다”…서천 묻지마 살인, 1시간 배회 끝 범행", lede:"충남 서천에서 30대 지적장애인이 1시간 넘게 범행 대상을 물색하다가 행인을 살해했다. 주민 불안이 커지고 있다.", img:IMAGES.seocheon_murder, policy:"흉악 범죄 예방을 위해 고위험군의 외부 활동을 제한해야 한다." } },
  { id:"busan_chem", topic:"재난/안전",
    neutral:{ title:"부산 강변대로 유해화학물질 유출, 2명 부상", lede:"부산 강변대로에서 유해화학물질이 유출돼 도로 관리원 2명이 부상을 입었다. 관계 당국이 유출 경위를 조사 중이다.", img:IMAGES.busan_chem, policy:"화학물질 운반 차량에 대한 안전 점검을 의무화해야 한다." },
    fear:{ title:"부산 도심 유해물질 유출…시민 안전 ‘비상’", lede:"부산 강변대로에서 유해화학물질이 대량 유출돼 2명이 다쳤다. 추가 피해에 대한 우려가 커지고 있다.", img:IMAGES.busan_chem, policy:"화학물질 운반 차량에 대한 안전 점검을 의무화해야 한다." } },
  { id:"yellow_envelope", topic:"정책/노동",
    neutral:{ title:"‘노란 봉투법’ 국회 통과…하청·특수고용 노조 활동 확대", lede:"국회가 하청·특수고용 노동자가 원청을 상대로 노조 활동을 할 수 있도록 하는 내용을 담은 법안을 의결했다.", img:IMAGES.yellow_envelope, policy:"하청·특수고용 노동자에게 원청 상대 노조 활동을 허용해야 한다." },
    fear:{ title:"노란 봉투법 통과…기업 경영 부담·경제 악영향 우려", lede:"노조 권한 강화로 기업 활동 위축이 우려된다는 지적이 나온다.", img:IMAGES.yellow_envelope, policy:"하청·특수고용 노동자에게 원청 상대 노조 활동을 허용해야 한다." } },

  // 추가 5개
  { id:"cyber_attack", topic:"치안/사이버",
    neutral:{ title:"공공기관 웹사이트, 일시적 접속 지연…보안 점검 진행", lede:"일부 공공기관 사이트에서 트래픽 급증으로 접속 지연이 발생해 보안 점검이 이뤄졌다.", img:IMAGES.cyber, policy:"공공기관의 보안 인력과 모의훈련 예산을 확대해야 한다." },
    fear:{ title:"대규모 해킹 시도…공공기관 마비 우려", lede:"연쇄적 해킹 시도로 공공기관 사이트가 마비될 수 있다는 우려가 제기됐다.", img:IMAGES.cyber, policy:"공공기관의 보안 인력과 모의훈련 예산을 확대해야 한다." } },
  { id:"ai_jobs", topic:"경제/일자리",
    neutral:{ title:"기업, 반복업무에 AI 도입 확대…직무 재설계 논의", lede:"여러 기업이 반복·문서 작업에 AI를 도입하면서 직무 재설계와 교육이 진행되고 있다.", img:IMAGES.ai_jobs, policy:"정부가 재직자 전환교육 바우처를 지원해야 한다." },
    fear:{ title:"AI 확산에 일자리 대체 가속…청년 고용 ‘경고등’", lede:"AI가 빠르게 도입되며 일부 직무의 일자리 감소 가능성이 제기된다.", img:IMAGES.ai_jobs, policy:"정부가 재직자 전환교육 바우처를 지원해야 한다." } },
  { id:"inflation", topic:"경제/물가",
    neutral:{ title:"생활물가 소폭 상승…정부, 할인 지원 연장", lede:"신선식품 중심으로 생활물가가 소폭 상승해 정부가 할인 지원을 연장하기로 했다.", img:IMAGES.inflation, policy:"생필품 가격 모니터링과 할인 정책을 확대해야 한다." },
    fear:{ title:"장바구니 물가 ‘또 급등’…가계 부담 커진다", lede:"생활필수품 가격이 잇따라 오르며 가계 부담이 커지고 있다.", img:IMAGES.inflation, policy:"생필품 가격 모니터링과 할인 정책을 확대해야 한다." } },
  { id:"heatwave", topic:"재난/기후",
    neutral:{ title:"도심 열섬 현상 확대…그늘·쿨루프 사업 추진", lede:"지자체가 그늘막, 쿨루프 등 폭염 완화 사업을 확대한다.", img:IMAGES.heatwave, policy:"폭염 경보 시 공공 냉방시설을 무료 개방해야 한다." },
    fear:{ title:"기록적 폭염 비상…온열질환 급증 우려", lede:"연일 이어지는 폭염으로 취약계층의 건강 피해가 우려된다.", img:IMAGES.heatwave, policy:"폭염 경보 시 공공 냉방시설을 무료 개방해야 한다." } },
  { id:"subway_incident", topic:"대중교통/안전",
    neutral:{ title:"지하철 소란, 신속 수습…운행 정상화", lede:"출근길 지하철에서 소란이 있었지만 신속히 수습됐다.", img:IMAGES.subway, policy:"대중교통 보안요원 배치를 확대해야 한다." },
    fear:{ title:"출근길 지하철서 승객 ‘아찔’…안전 불안 커져", lede:"지하철 차량 내 소란으로 승객들이 불안을 호소했다.", img:IMAGES.subway, policy:"대중교통 보안요원 배치를 확대해야 한다." } }
];

// ===== 트랙 매핑(우선 노출) =====
const TOPIC_TRACKS = {
  '교육/학업중단':['media','psych'],
  '안보/국제':['media','law'],
  '치안/마약':['media','psych','law'],
  '해외/범죄':['psych','law'],
  '묻지마 범죄':['psych','law'],
  '재난/안전':['media','econ'],
  '정책/노동':['media','law','econ'],
  '치안/사이버':['media','law'],
  '경제/일자리':['econ','media'],
  '경제/물가':['econ'],
  '재난/기후':['media','econ'],
  '대중교통/안전':['media','law']
};
const matchesTrack = (topic, track)=>(TOPIC_TRACKS[topic]||[]).includes(track);

// ===== 유틸 =====
const $ = (id)=>document.getElementById(id);
const shuffle = (arr)=>arr.sort(()=>Math.random()-0.5);
const download = (filename, text)=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'})); a.download=filename; a.click(); URL.revokeObjectURL(a.href); };
const toCSV = (rows)=>{ if(!rows.length) return ''; const cols=Object.keys(rows[0]); const head=cols.join(','); const body=rows.map(r=>cols.map(c=>`"${String(r[c]??'').replaceAll('"','""')}"`).join(',')).join('\n'); return head+'\n'+body; };

// ===== 상태 =====
let POOL = SINGLE_ITEMS;          // 이번 플레이에 사용할 6개
let sequence = [];                // 라운드 순서(0..POOL.length-1)
let idx = 0;
let startTime = 0;
let currentPolicyChoice = null;

const LS_KEY = 'al_records_random_photo_v4';
const LS_UNSENT = 'al_unsent_random_photo_v4';
let saved = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
let unsent = JSON.parse(localStorage.getItem(LS_UNSENT)||'[]');

// ===== 전송 =====
async function postRows(rows){
  const payload={token:TOKEN, rows};
  const res=await fetch(ENDPOINT,{method:'POST', body:JSON.stringify(payload)});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return res.text();
}
async function flushUnsent(){
  if(!unsent.length) return true;
  $('onlineState').textContent = `미전송 ${unsent.length}건 전송 중…`;
  try{ await postRows(unsent); unsent=[]; localStorage.setItem(LS_UNSENT, JSON.stringify(unsent)); $('onlineState').textContent='온라인 전송 정상'; $('onlineState').className='badge ok'; return true; }
  catch(e){ $('onlineState').textContent='전송 실패(보관 중)'; $('onlineState').className='badge fail'; return false; }
}

// ===== 슬라이더 스냅 + 배지 =====
function snapInt1to5(el){ let v=Math.round(Number(el.value||3)); v=Math.max(1,Math.min(5,v)); if(String(v)!==el.value) el.value=String(v); }
function bindSlider(id,badgeId){ const el=$(id), badge=$(badgeId); if(!el) return; const upd=()=>{ snapInt1to5(el); if(badge) badge.textContent=`${el.value} / 5`; }; el.addEventListener('input',upd); el.addEventListener('change',upd); upd(); }

// ===== 초기화 =====
window.addEventListener('DOMContentLoaded', ()=>{
  $('btnStart').addEventListener('click', start);
  $('btnPing').addEventListener('click', sendPing);
  $('btnNext').addEventListener('click', nextSingle);
  $('btnReplay').addEventListener('click', ()=>location.reload());
  $('btnExport').addEventListener('click', ()=>download('anxiety_lab_records.csv', toCSV(saved)));
  $('btnClear').addEventListener('click', ()=>{ if(confirm('기기에 저장된 데이터를 모두 삭제할까요?')){ saved=[]; unsent=[]; localStorage.removeItem(LS_KEY); localStorage.removeItem(LS_UNSENT); alert('삭제 완료'); } });
  $('btnResend').addEventListener('click', flushUnsent);

  // 키보드 1~5 → 슬라이더 + 배지 동기화
  window.addEventListener('keydown', (e)=>{
    if(!['1','2','3','4','5'].includes(e.key)) return;
    const s = $('anxiety'), b = $('anxietyVal');
    s.value = e.key; snapInt1to5(s); if(b) b.textContent = `${s.value} / 5`;
  });

  document.querySelectorAll('#policyBtns button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      currentPolicyChoice=btn.dataset.v;
      document.querySelectorAll('#policyBtns button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active'); $('btnNext').classList.remove('disabled');
    });
  });

  bindSlider('anxiety','anxietyVal');

  if(unsent.length){ $('onlineState').textContent=`미전송 ${unsent.length}건 보관 중`; $('onlineState').className='badge fail'; }
});

// ===== 연결 테스트 =====
async function sendPing(){
  const row={timestamp:new Date().toISOString(), nickname:'PING', track:'media', trial_index:0, item_id:'ping', topic:'ping', variant:'ping', title:'PING TEST', policy_prompt:'PING', anxiety_1to5:0, policy_attitude:'PING', rt_ms:0};
  $('onlineState').textContent='테스트 전송 중…'; $('onlineState').className='badge';
  try{ await postRows([row]); $('onlineState').textContent='연결 정상(PING 기록됨)'; $('onlineState').className='badge ok'; }
  catch(e){ $('onlineState').textContent='연결 실패(설정 확인 필요)'; $('onlineState').className='badge fail'; }
}

// ===== 흐름 =====
function start(){
  const chosen = $('track').value; // media/psych/law/econ

  // 1) 트랙 맞는 기사 우선
  const primary = SINGLE_ITEMS.filter(it => matchesTrack(it.topic, chosen));
  const rest = SINGLE_ITEMS.filter(it => !primary.includes(it));

  // 2) 부족분 보충 → 6개 선정
  POOL = [...primary, ...shuffle(rest)];
  POOL = POOL.slice(0, MAX_ROUNDS);

  // 3) 라운드 시퀀스(0..POOL.length-1) 섞기
  sequence = Array.from({length: POOL.length}, (_,i)=>i);
  sequence = shuffle(sequence);

  idx = 0;
  $('screen-intro').classList.add('hidden');
  renderCurrent();
  flushUnsent();
}

function renderCurrent(){
  const cur = sequence[idx];
  const progress = Math.floor((idx / POOL.length) * 100);

  $('screen-trial').classList.remove('hidden');

  const item = POOL[cur];
  const variant = Math.random()<0.5 ? 'neutral' : 'fear';
  const v = item[variant];

  $('progBar').style.width = progress+'%';
  $('headline').textContent = v.title;
  $('lede').textContent = v.lede;
  $('image').src = v.img;
  $('policy').textContent = v.policy;

  $('anxiety').value = 3; snapInt1to5($('anxiety')); $('anxietyVal').textContent='3 / 5';
  currentPolicyChoice = null;
  document.querySelectorAll('#policyBtns button').forEach(b=>b.classList.remove('active'));
  $('btnNext').classList.add('disabled');
  $('sendState').textContent='전송 대기'; $('sendState').className='badge';

  // context
  const trial = $('screen-trial');
  trial.dataset.item_id = item.id;
  trial.dataset.topic   = item.topic;
  trial.dataset.variant = variant;
  trial.dataset.title   = v.title;
  trial.dataset.policy  = v.policy;

  startTime = performance.now();
}

async function nextSingle(){
  if($('btnNext').classList.contains('disabled')) return;
  const ms = Math.round(performance.now()-startTime);
  const row = {
    timestamp: new Date().toISOString(),
    nickname: $('nickname').value.trim(),
    track: $('track').value,
    trial_index: idx+1,
    item_id: $('screen-trial').dataset.item_id,
    topic: $('screen-trial').dataset.topic,
    variant: $('screen-trial').dataset.variant,
    title: $('screen-trial').dataset.title,
    policy_prompt: $('screen-trial').dataset.policy,
    anxiety_1to5: Number($('anxiety').value),
    policy_attitude: currentPolicyChoice,
    rt_ms: ms
  };
  saved.push(row); localStorage.setItem(LS_KEY, JSON.stringify(saved));
  $('sendState').textContent='전송 중…';
  try{ await postRows([row]); $('sendState').textContent='전송 성공'; $('sendState').className='badge ok'; }
  catch(e){ unsent.push(row); localStorage.setItem(LS_UNSENT, JSON.stringify(unsent)); $('sendState').textContent='전송 실패(보관)'; $('sendState').className='badge fail'; }

  idx++;
  if(idx < POOL.length) renderCurrent();
  else finish();
}

function finish(){
  $('screen-trial').classList.add('hidden');
  $('screen-finish').classList.remove('hidden');

  const total = POOL.length; // 6
  const last = saved.slice(-total);
  const avg = (arr)=> (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2);
  const fear = last.filter(r=>r.variant==='fear');
  const neu  = last.filter(r=>r.variant==='neutral');
  const fearAvg = fear.length?avg(fear.map(r=>r.anxiety_1to5)):'-';
  const neuAvg  = neu.length?avg(neu.map(r=>r.anxiety_1to5)):'-';

  const html = `
    <table>
      <tr><th>평균 불안(전체)</th><td>${avg(last.map(r=>r.anxiety_1to5))}</td></tr>
      <tr><th>공포 프레임 평균</th><td>${fearAvg}</td></tr>
      <tr><th>중립 프레임 평균</th><td>${neuAvg}</td></tr>
      <tr><th>표본 크기</th><td>${last.length}</td></tr>
    </table>
    <p class="hint small">CSV로 내보내면 라운드별 상세 데이터(제목, 변형, 불안도, 정책 태도)를 확인할 수 있어요.</p>
  `;
  $('summary').innerHTML = html;
}
</script>
</body>
</html>
